{"version":3,"file":"ReactNodeViewRenderer.js","sources":["../../../../../node_modules/@tiptap/react/src/ReactNodeViewRenderer.tsx"],"sourcesContent":["import React from 'react'\nimport {\n  NodeView,\n  NodeViewProps,\n  NodeViewRenderer,\n  NodeViewRendererProps,\n  NodeViewRendererOptions,\n} from '@tiptap/core'\nimport { Decoration, NodeView as ProseMirrorNodeView } from 'prosemirror-view'\nimport { Node as ProseMirrorNode } from 'prosemirror-model'\nimport { Editor } from './Editor'\nimport { ReactRenderer } from './ReactRenderer'\nimport { ReactNodeViewContext, ReactNodeViewContextProps } from './useReactNodeView'\n\nexport interface ReactNodeViewRendererOptions extends NodeViewRendererOptions {\n  update: ((props: {\n    oldNode: ProseMirrorNode,\n    oldDecorations: Decoration[],\n    newNode: ProseMirrorNode,\n    newDecorations: Decoration[],\n    updateProps: () => void,\n  }) => boolean) | null,\n  as?: string,\n}\n\nclass ReactNodeView extends NodeView<React.FunctionComponent, Editor, ReactNodeViewRendererOptions> {\n\n  renderer!: ReactRenderer\n\n  contentDOMElement!: HTMLElement | null\n\n  mount() {\n    const props: NodeViewProps = {\n      editor: this.editor,\n      node: this.node,\n      decorations: this.decorations,\n      selected: false,\n      extension: this.extension,\n      getPos: () => this.getPos(),\n      updateAttributes: (attributes = {}) => this.updateAttributes(attributes),\n      deleteNode: () => this.deleteNode(),\n    }\n\n    if (!(this.component as any).displayName) {\n      const capitalizeFirstChar = (string: string): string => {\n        return string.charAt(0).toUpperCase() + string.substring(1)\n      }\n\n      this.component.displayName = capitalizeFirstChar(this.extension.name)\n    }\n\n    const ReactNodeViewProvider: React.FunctionComponent = componentProps => {\n      const Component = this.component\n      const onDragStart = this.onDragStart.bind(this)\n      const nodeViewContentRef: ReactNodeViewContextProps['nodeViewContentRef'] = element => {\n        if (\n          element\n          && this.contentDOMElement\n          && element.firstChild !== this.contentDOMElement\n        ) {\n          element.appendChild(this.contentDOMElement)\n        }\n      }\n\n      return (\n        <ReactNodeViewContext.Provider value={{ onDragStart, nodeViewContentRef }}>\n          <Component {...componentProps} />\n        </ReactNodeViewContext.Provider>\n      )\n    }\n\n    ReactNodeViewProvider.displayName = 'ReactNodeView'\n\n    this.contentDOMElement = this.node.isLeaf\n      ? null\n      : document.createElement(this.node.isInline ? 'span' : 'div')\n\n    if (this.contentDOMElement) {\n      // For some reason the whiteSpace prop is not inherited properly in Chrome and Safari\n      // With this fix it seems to work fine\n      // See: https://github.com/ueberdosis/tiptap/issues/1197\n      this.contentDOMElement.style.whiteSpace = 'inherit'\n    }\n\n    let as = this.node.isInline ? 'span' : 'div'\n\n    if (this.options.as) {\n      as = this.options.as\n    }\n\n    this.renderer = new ReactRenderer(ReactNodeViewProvider, {\n      editor: this.editor,\n      props,\n      as,\n      className: `node-${this.node.type.name}`,\n    })\n  }\n\n  get dom() {\n    if (\n      this.renderer.element.firstElementChild\n      && !this.renderer.element.firstElementChild?.hasAttribute('data-node-view-wrapper')\n    ) {\n      throw Error('Please use the NodeViewWrapper component for your node view.')\n    }\n\n    return this.renderer.element\n  }\n\n  get contentDOM() {\n    if (this.node.isLeaf) {\n      return null\n    }\n\n    return this.contentDOMElement\n  }\n\n  update(node: ProseMirrorNode, decorations: Decoration[]) {\n    const updateProps = (props?: Record<string, any>) => {\n      this.renderer.updateProps(props)\n    }\n\n    if (node.type !== this.node.type) {\n      return false\n    }\n\n    if (typeof this.options.update === 'function') {\n      const oldNode = this.node\n      const oldDecorations = this.decorations\n\n      this.node = node\n      this.decorations = decorations\n\n      return this.options.update({\n        oldNode,\n        oldDecorations,\n        newNode: node,\n        newDecorations: decorations,\n        updateProps: () => updateProps({ node, decorations }),\n      })\n    }\n\n    if (node === this.node && this.decorations === decorations) {\n      return true\n    }\n\n    this.node = node\n    this.decorations = decorations\n\n    updateProps({ node, decorations })\n\n    return true\n  }\n\n  selectNode() {\n    this.renderer.updateProps({\n      selected: true,\n    })\n  }\n\n  deselectNode() {\n    this.renderer.updateProps({\n      selected: false,\n    })\n  }\n\n  destroy() {\n    this.renderer.destroy()\n    this.contentDOMElement = null\n  }\n}\n\nexport function ReactNodeViewRenderer(component: any, options?: Partial<ReactNodeViewRendererOptions>): NodeViewRenderer {\n  return (props: NodeViewRendererProps) => {\n    // try to get the parent component\n    // this is important for vue devtools to show the component hierarchy correctly\n    // maybe it’s `undefined` because <editor-content> isn’t rendered yet\n    if (!(props.editor as Editor).contentComponent) {\n      return {}\n    }\n\n    return new ReactNodeView(component, props, options) as ProseMirrorNodeView\n  }\n}\n"],"names":["__extends","_jsx","ReactNodeViewContext","__assign","ReactRenderer","NodeView"],"mappings":"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"}